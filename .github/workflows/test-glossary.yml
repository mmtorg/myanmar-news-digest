name: Test Region Glossary (Google Sheet) — development / spreadsheet

on:
    workflow_dispatch:
        inputs:
            sheet_id:
                description: "Google Sheet ID（未入力なら secrets.MNA_SHEET_ID を使用）"
                required: false
                type: string
            show_entries:
                description: "先頭から何件表示するか"
                required: false
                default: "10"
                type: string

jobs:
    test-glossary:
        runs-on: ubuntu-latest
        # development環境・spreadsheetブランチでのみ動作
        if: ${{ github.ref_name == 'spreadsheet' }}
        environment: development

        env:
            SHEET_ID_INPUT: ${{ inputs.sheet_id }}
            SHEET_ID_SECRET: ${{ secrets.MNA_SHEET_ID }}
            SHEET_NAME: "regions"
            SHOW_ENTRIES: ${{ inputs.show_entries }}
            GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
            GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
            MNA_SHEET_ID: ${{ inputs.sheet_id != '' && inputs.sheet_id || secrets.MNA_SHEET_ID }}
            MNA_REGION_SHEET_NAME: "regions"
            # 既存ファイルで使われてる
            PAID_PLAN_URL: ${{ secrets.PAID_PLAN_URL }}
            GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_TEST_SUMMARY_KEY }}
            GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_TEST_DEDUPE_KEY }}
            GEMINI_API_FULLTEXT_KEY: ${{ secrets.GEMINI_API_TEST_FULLTEXT_KEY }}

        steps:
            - name: Checkout spreadsheet branch
              uses: actions/checkout@v4
              with:
                  ref: spreadsheet

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install deps (requirements.txt if exists) + minimal libs
              run: |
                  set -euxo pipefail
                  if [ -f requirements.txt ]; then
                    pip install -r requirements.txt
                  fi
                  pip install gspread google-auth

            - name: Test region glossary loading
              run: |
                  python - <<'PY'
                  import os, json, inspect
                  from importlib import import_module

                  # 1) シート／タブ／認証
                  sheet_id   = os.getenv("MNA_SHEET_ID") or ""
                  sheet_name = os.getenv("MNA_REGION_SHEET_NAME") or "regions"
                  show       = max(1, int(os.getenv("SHOW_ENTRIES") or "10"))

                  # fetch_articles 側が参照しうる環境変数名を**全部**埋めておく（片方しか見ない実装対策）
                  sa = os.getenv("GOOGLE_SERVICE_ACCOUNT_JSON") or ""
                  if sa:
                      os.environ.setdefault("GOOGLE_CREDENTIALS_JSON", sa)           # 別名
                      os.environ.setdefault("GOOGLE_APPLICATION_CREDENTIALS_JSON", sa) # 念のため

                  # タブ名も複数候補で上書き（実装差異を吸収）
                  for k in [
                      "MNA_REGION_SHEET_NAME",
                      "MNA_REGION_GLOSSARY_SHEET_NAME",
                      "REGION_GLOSSARY_SHEET_NAME",
                      "REGION_SHEET_NAME",
                  ]:
                      os.environ.setdefault(k, sheet_name)

                  print("=== Test Region Glossary (Google Sheet) ===")
                  print("branch: spreadsheet")
                  print("environment: development")
                  print("sheet_id_present:", bool(sheet_id))
                  print("sheet_name:", sheet_name)
                  print("creds_present:", bool(sa))

                  try:
                      fa = import_module("fetch_articles")

                      # 2) ローダ関数を見つける
                      cand_names = [
                          "_load_region_glossary_gsheet",
                          "load_region_glossary_gsheet",
                          "_load_region_glossary",
                      ]
                      loader = None
                      for n in cand_names:
                          loader = getattr(fa, n, None)
                          if callable(loader):
                              chosen = n
                              break

                      entries = []
                      if callable(loader):
                          # 3) シグネチャに合わせて**確実に**渡す
                          sig = inspect.signature(loader)
                          params = sig.parameters
                          called = ""
                          try:
                              if {"sheet_key","worksheet"} <= set(params):
                                  entries = loader(sheet_key=sheet_id, worksheet=sheet_name) or []
                                  called = f"{chosen}(sheet_key=..., worksheet=...)"
                              elif "sheet_key" in params:
                                  entries = loader(sheet_key=sheet_id) or []
                                  called = f"{chosen}(sheet_key=...)"
                              elif "worksheet" in params:
                                  entries = loader(worksheet=sheet_name) or []
                                  called = f"{chosen}(worksheet=...)"
                              else:
                                  # 位置引数のみの可能性
                                  try:
                                      entries = loader(sheet_id, sheet_name) or []
                                      called = f"{chosen}(<sheet_id>, <sheet_name>)"
                                  except TypeError:
                                      try:
                                          entries = loader(sheet_id) or []
                                          called = f"{chosen}(<sheet_id>)"
                                      except TypeError:
                                          entries = loader() or []
                                          called = f"{chosen}()"
                          except Exception as e:
                              print(f"[loader-call-error] {e!r}")
                              entries = []

                          print("loader_called_as:", called)
                          print("loaded_entries:", len(entries))
                          if entries:
                              for i, x in enumerate(entries[:show], 1):
                                  mm = (x.get("mm") or x.get("Myanmar") or "").strip()
                                  en = (x.get("en") or x.get("English") or "").strip()
                                  ja = (x.get("ja") or x.get("Japanese") or "").strip()
                                  print(f"{i:02d}. {en} / {mm} -> {ja}")
                          else:
                              print("⚠️ No glossary loaded (check Sheet ID / credentials / worksheet name / sharing).")

                      else:
                          # 4) ローダが無い場合：sheet_pipeline のプロンプト経由で確認
                          try:
                              sp = import_module("sheet_pipeline")
                              pf = getattr(sp, "_build_region_glossary_prompt", None)
                              if callable(pf):
                                  prompt = pf() or ""
                                  lines = [ln for ln in prompt.splitlines() if ln.strip().startswith("- ")]
                                  print("loaded_entries(via prompt):", len(lines))
                                  for i, ln in enumerate(lines[:show], 1):
                                      print(f"{i:02d}.", ln[2:])
                              else:
                                  print("⚠️ _build_region_glossary_prompt not found.")
                          except Exception as e2:
                              print("⚠️ No glossary loaded (prompt). detail:", repr(e2))

                  except Exception as e:
                      print("ERROR: failed to import/use fetch_articles:", repr(e))
                      raise
                  PY

            - name: Diagnostics | list worksheets & first rows
              run: |
                  python - <<'PY'
                  import os, json
                  import gspread
                  from google.oauth2.service_account import Credentials

                  sj = os.getenv("GOOGLE_SERVICE_ACCOUNT_JSON") or ""
                  if not sj:
                      print("no SA json found in env"); raise SystemExit(0)

                  scopes=["https://www.googleapis.com/auth/spreadsheets.readonly"]
                  creds=Credentials.from_service_account_info(json.loads(sj), scopes=scopes)
                  gc=gspread.authorize(creds)

                  sid=os.getenv("MNA_SHEET_ID")
                  ws_name=os.getenv("MNA_REGION_SHEET_NAME") or "regions"

                  ss=gc.open_by_key(sid)
                  print("worksheets:", [w.title for w in ss.worksheets()])
                  try:
                      ws=ss.worksheet(ws_name)
                      vals=ws.get_all_values() or []
                      print("rows_total:", len(vals))
                      for i,row in enumerate(vals[:5], start=1):
                          print(f"row{i}:", row)
                  except Exception as e:
                      print("worksheet_open_error:", repr(e))
                  PY
