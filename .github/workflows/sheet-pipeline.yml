name: Daily Myanmar News Alert Sheet Pipeline

on:
  # スケジュールは「デフォルトブランチ」でのみ動作します（通常は main）。
  # => 本番のみスケジュール実行したい要件を満たします。
  # GitHub Actions の cron は UTC です（MMT = UTC+06:30）
  schedule:
    # 15:50 MMT（= 09:20 UTC）: 前日クリア → 追記
    # 15:50 MMT ≒ 09:20 UTC → 09:17 UTC（= 15:47 MMT, 3分前倒し）
    - cron: "17 9 * * *" # 15:47 MMT（実運用目標: 15:50）

    # 17:50 / 20:50 / 22:50 MMT（= 11:20 / 14:20 / 16:20 UTC）: 追記のみ
    # 17:50 MMT ≒ 11:20 UTC → 11:17 UTC（= 17:47 MMT, 3分前倒し）
    - cron: "17 11 * * *" # 17:47 MMT（実運用目標: 17:50）
    # 20:50 MMT ≒ 14:20 UTC → 14:17 UTC（= 20:47 MMT, 3分前倒し）
    - cron: "17 14 * * *" # 20:47 MMT（実運用目標: 20:50）
    # 22:50 MMT ≒ 16:20 UTC → 16:17 UTC（= 22:47 MMT, 3分前倒し）
    - cron: "17 16 * * *" # 22:47 MMT（実運用目標: 22:50）

    # 02:30 MMT（= 20:00 UTC 前日）: bundle生成
    # 02:30 MMT（翌日）≒ 20:00 UTC（前日）→ 19:57 UTC（= 02:27 MMT, 3分前倒し）
    - cron: "57 19 * * *" # 02:27 MMT（実運用目標: 02:30）

  workflow_dispatch:
    inputs:
      mode:
        description: "collect16（15:50回） / collect（17:50/20:50/22:50回） / build-bundle（02:30）"
        type: choice
        required: true
        default: collect16
        options:
          - collect16
          - collect
          - build-bundle
          - notify-email

# どのイベントでも 1 workflow につき環境ごとに直列化
concurrency:
  # 手動実行: main→production / develop→development / その他→production（元の式を踏襲）
  group: mna-sheet-pipeline-${{ github.event_name == 'workflow_dispatch' && (github.ref_name == 'main' && 'production' || 'development') || 'production' }}
  cancel-in-progress: false

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  # === スケジュール（本番のみ / mainブランチ運用前提） ===
  schedule-collect16:
    # 15:50 枠（09:17 UTC 起動）
    if: github.event_name == 'schedule' && github.event.schedule == '17 9 * * *'
    runs-on: ubuntu-latest
    # 環境別シークレット（Environments）の切替：本番固定
    environment: production
    # ▼ 環境変数（prod用）のみ追加（ここでのmulti-lineはOK：$GITHUB_ENV経由ではない）
    env:
      # ===== Gemini（production）=====
      GEMINI_API_KEY_MIZZIMA: ${{ secrets.GEMINI_API_KEY_MIZZIMA }}
      GEMINI_API_KEY_BBC: ${{ secrets.GEMINI_API_KEY_BBC }}
      GEMINI_API_KEY_IRRAWADDY: ${{ secrets.GEMINI_API_KEY_IRRAWADDY }}
      GEMINI_API_KEY_KHITTHIT: ${{ secrets.GEMINI_API_KEY_KHITTHIT }}
      GEMINI_API_KEY_MYANMARNOW: ${{ secrets.GEMINI_API_KEY_MYANMARNOW }}
      GEMINI_API_KEY_DVB: ${{ secrets.GEMINI_API_KEY_DVB }}
      GEMINI_REQS_PER_MIN: 6
      GEMINI_MIN_INTERVAL_SEC: 2.5
      GEMINI_JITTER_SEC: 0.5
      # ===== Google Sheets（production）=====
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      MNA_SHEET_ID: ${{ secrets.MNA_SHEET_ID }}
      MNA_SHEET_NAME: "prod"
      # ===== fetch_articles.pyで使う環境変数（production）=====
      GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_SUMMARY_KEY }}
      GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_DEDUPE_KEY }}
      GEMINI_API_FULLTEXT_KEY: ${{ secrets.GEMINI_API_FULLTEXT_KEY }}
    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Diagnostics | env + tree
        run: |
          set -euxo pipefail
          echo "PWD=$(pwd)"
          python --version
          find . -maxdepth 2 -type d -print | sort

      - name: Diagnostics | gemini keys present? (masked)
        run: |
          python - <<'PY'
          import os
          keys = sorted(k for k in os.environ if k.startswith("GEMINI"))
          print("gemini_key_names:", keys)
          print("gemini_keys_nonempty:", {k: bool(os.environ.get(k)) for k in keys})
          PY

      - name: Write GOOGLE_APPLICATION_CREDENTIALS
        if: env.GOOGLE_SERVICE_ACCOUNT_JSON != ''
        run: |
          SA_FILE="$RUNNER_TEMP/sa.json"
          printf '%s' "${GOOGLE_SERVICE_ACCOUNT_JSON}" > "$SA_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$SA_FILE" >> "$GITHUB_ENV"
          echo "GOOGLE_SERVICE_ACCOUNT_FILE=$SA_FILE" >> "$GITHUB_ENV"

      - name: Collect → write to sheet (15:50 run, clear yesterday once)
        run: |
          python sheet_pipeline.py collect-to-sheet --clear-yesterday

      # ★ 15:50 枠の収集完了時にメール通知
      - name: Notify by email via Python (cron 15:50 MMT)
        if: ${{ github.event_name == 'schedule' && success() }}
        run: |
          set -euo pipefail
          BODY="$(printf '%s\n%s\n%s\n' \
            '✅ 15:50収集 完了（本番用）' \
            '・対象シート: 「prod」シートに追記済みです。' \
            '・17:50 / 20:50 / 22:50 の収集が順次実行予定です。' )"
          python notify_done.py \
            --to "${CSV_EMAIL_RECIPIENTS}" \
            --subject "【MNA 記事収集】15:50収集 完了（本番用）" \
            --body "$BODY" \
            --sheet-url "https://docs.google.com/spreadsheets/d/${{ secrets.MNA_SHEET_ID }}/edit"
        env:
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          CSV_EMAIL_RECIPIENTS: ${{ secrets.CSV_EMAIL_RECIPIENTS }}

  schedule-collect:
    # 17:50 / 20:50 / 22:50 枠
    if: github.event_name == 'schedule' && contains(fromJson('["17 11 * * *","17 14 * * *","17 16 * * *"]'), github.event.schedule)
    runs-on: ubuntu-latest
    environment: production
    env:
      # ===== Gemini（production）=====
      GEMINI_API_KEY_MIZZIMA: ${{ secrets.GEMINI_API_KEY_MIZZIMA }}
      GEMINI_API_KEY_BBC: ${{ secrets.GEMINI_API_KEY_BBC }}
      GEMINI_API_KEY_IRRAWADDY: ${{ secrets.GEMINI_API_KEY_IRRAWADDY }}
      GEMINI_API_KEY_KHITTHIT: ${{ secrets.GEMINI_API_KEY_KHITTHIT }}
      GEMINI_API_KEY_MYANMARNOW: ${{ secrets.GEMINI_API_KEY_MYANMARNOW }}
      GEMINI_API_KEY_DVB: ${{ secrets.GEMINI_API_KEY_DVB }}
      GEMINI_REQS_PER_MIN: 6
      GEMINI_MIN_INTERVAL_SEC: 2.5
      GEMINI_JITTER_SEC: 0.5
      # ===== Google Sheets（production）=====
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      MNA_SHEET_ID: ${{ secrets.MNA_SHEET_ID }}
      MNA_SHEET_NAME: "prod"
      # ===== fetch_articles.pyで使う環境変数（production）=====
      GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_SUMMARY_KEY }}
      GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_DEDUPE_KEY }}
      GEMINI_API_FULLTEXT_KEY: ${{ secrets.GEMINI_API_FULLTEXT_KEY }}
    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Diagnostics | env + tree
        run: |
          set -euxo pipefail
          echo "PWD=$(pwd)"
          python --version
          find . -maxdepth 2 -type d -print | sort

      - name: Diagnostics | gemini keys present? (masked)
        run: |
          python - <<'PY'
          import os
          keys = sorted(k for k in os.environ if k.startswith("GEMINI"))
          print("gemini_key_names:", keys)
          print("gemini_keys_nonempty:", {k: bool(os.environ.get(k)) for k in keys})
          PY

      - name: Write GOOGLE_APPLICATION_CREDENTIALS
        if: env.GOOGLE_SERVICE_ACCOUNT_JSON != ''
        run: |
          SA_FILE="$RUNNER_TEMP/sa.json"
          printf '%s' "${GOOGLE_SERVICE_ACCOUNT_JSON}" > "$SA_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$SA_FILE" >> "$GITHUB_ENV"
          echo "GOOGLE_SERVICE_ACCOUNT_FILE=$SA_FILE" >> "$GITHUB_ENV"

      - name: Collect → append to sheet (17:50/20:50/22:50 runs)
        run: |
          python sheet_pipeline.py collect-to-sheet

      # ★ 17:50 / 20:50 / 22:50 枠ごとに、collect 完了後にメール通知
      - name: Notify by email via Python (cron 17:50/20:50/22:50 MMT)
        if: ${{ github.event_name == 'schedule' && success() }}
        run: |
          set -euo pipefail
          # github.event.schedule から MMT 時刻ラベルを決定
          case "${{ github.event.schedule }}" in
            "17 11 * * *") SLOT_LABEL="17:50" ;;
            "17 14 * * *") SLOT_LABEL="20:50" ;;
            "17 16 * * *") SLOT_LABEL="22:50" ;;
            *)             SLOT_LABEL="定期収集" ;;
          esac
          BODY="$(printf '%s\n%s\n%s\n' \
            "✅ ${SLOT_LABEL}収集 完了（本番用）" \
            '・対象シート: 「prod」シートに追記済みです。' \
            '・翌 02:30 までにスプレッドシートの更新を完了してください。' )"
          python notify_done.py \
            --to "${CSV_EMAIL_RECIPIENTS}" \
            --subject "【MNA 記事収集】${SLOT_LABEL}収集 完了（本番用）" \
            --body "$BODY" \
            --sheet-url "https://docs.google.com/spreadsheets/d/${{ secrets.MNA_SHEET_ID }}/edit"
        env:
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          # 任意: From 表示名を固定したい場合のみ
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          # 受信先（未設定だと --to が空になって失敗）
          CSV_EMAIL_RECIPIENTS: ${{ secrets.CSV_EMAIL_RECIPIENTS }}

  schedule-build-bundle:
    if: github.event_name == 'schedule' && github.event.schedule == '57 19 * * *'
    runs-on: ubuntu-latest
    environment: production
    env:
      # ===== Gemini（production）=====
      GEMINI_API_KEY_MIZZIMA: ${{ secrets.GEMINI_API_KEY_MIZZIMA }}
      GEMINI_API_KEY_BBC: ${{ secrets.GEMINI_API_KEY_BBC }}
      GEMINI_API_KEY_IRRAWADDY: ${{ secrets.GEMINI_API_KEY_IRRAWADDY }}
      GEMINI_API_KEY_KHITTHIT: ${{ secrets.GEMINI_API_KEY_KHITTHIT }}
      GEMINI_API_KEY_MYANMARNOW: ${{ secrets.GEMINI_API_KEY_MYANMARNOW }}
      GEMINI_API_KEY_DVB: ${{ secrets.GEMINI_API_KEY_DVB }}
      GEMINI_REQS_PER_MIN: 6
      GEMINI_MIN_INTERVAL_SEC: 2.5
      GEMINI_JITTER_SEC: 0.5
      # ===== Google Sheets（production）=====
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      MNA_SHEET_ID: ${{ secrets.MNA_SHEET_ID }}
      MNA_SHEET_NAME: "prod"
      # ===== fetch_articles.pyで使う環境変数（production）=====
      GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_SUMMARY_KEY }}
      GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_DEDUPE_KEY }}
      GEMINI_API_FULLTEXT_KEY: ${{ secrets.GEMINI_API_FULLTEXT_KEY }}
    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write GOOGLE_APPLICATION_CREDENTIALS
        if: env.GOOGLE_SERVICE_ACCOUNT_JSON != ''
        run: |
          SA_FILE="$RUNNER_TEMP/sa.json"
          printf '%s' "${GOOGLE_SERVICE_ACCOUNT_JSON}" > "$SA_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$SA_FILE" >> "$GITHUB_ENV"
          echo "GOOGLE_SERVICE_ACCOUNT_FILE=$SA_FILE" >> "$GITHUB_ENV"

      - name: Assert vendored fonts & export PDF_FONT_PATH
        run: |
          set -euxo pipefail
          ls -al "$GITHUB_WORKSPACE/fonts"
          test -f "$GITHUB_WORKSPACE/fonts/NotoSansJP-Regular.ttf"
          test -f "$GITHUB_WORKSPACE/fonts/NotoSansJP-Bold.ttf"
          echo "PDF_FONT_PATH=$GITHUB_WORKSPACE/fonts/NotoSansJP-Regular.ttf" >> "$GITHUB_ENV"
          echo "PDF_FONT_BOLD_PATH=$GITHUB_WORKSPACE/fonts/NotoSansJP-Bold.ttf" >> "$GITHUB_ENV"
          echo "PDF_FONT_PATH=${PDF_FONT_PATH:-<not-set>}"

      # === Diagnostics: ランナー環境と bundle の状況を確認（読み取りのみ） ===
      - name: Diagnostics | env + tree
        run: |
          set -euxo pipefail
          echo "PWD=$(pwd)"
          python --version
          echo "--- repo tree (top 2 levels) ---"
          find . -maxdepth 2 -type d -print | sort
          echo "--- bundle dir ---"
          ls -al bundle || true

      - name: Diagnostics | can import helpers?
        run: |
          python - <<'PY'
          from importlib import import_module
          m = import_module("fetch_articles")
          req = ["translate_fulltexts_for_business", "build_combined_pdf_for_business", "_jp_date"]
          ok = all(hasattr(m, x) for x in req)
          print("helpers_importable:", ok)
          print("module_file:", getattr(m, "__file__", None))
          PY

      - name: Diagnostics | gemini keys present? (masked)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import os
          keys = sorted(k for k in os.environ if k.startswith("GEMINI"))
          print("gemini_key_names:", keys)
          # 値は True/False のみ表示（中身は GitHub が自動マスク）
          print("gemini_keys_nonempty:", {k: bool(os.environ.get(k)) for k in keys})
          PY

      # === 送信直前の build-bundle（PDF & 添付名を確実に生成） ===
      - name: Build bundle (PDF & attachment name)
        env:
          MNA_LOG_LEVEL: INFO # 必要に応じて DEBUG に
        run: |
          set -euxo pipefail
          python sheet_pipeline.py build-bundle --bundle-dir bundle
          echo "--- bundle after build-bundle ---"
          ls -al bundle

      - name: Diagnostics | summaries/bodies coverage
        run: |
          python - <<'PY'
          import os, json, sys
          b = "bundle"
          s = os.path.join(b, "summaries.json")
          if not os.path.exists(s):
              print("[!] bundle/summaries.json not found (skipping coverage)"); sys.exit(0)
          summaries = json.load(open(s, encoding="utf-8"))
          print("selected_count:", len(summaries))
          bp = os.path.join(b, "bodies.json")
          cache = {}
          if os.path.exists(bp):
              cache = json.load(open(bp, encoding="utf-8"))
          missing = []
          short = []
          for it in summaries:
              u = it.get("url","")
              if not u: continue
              body = (cache.get(u) or {}).get("body","")
              if not body:
                  missing.append(u)
              elif len(body.strip()) < 80:
                  short.append(u)
          print("in_cache:", len(cache), "missing_bodies:", len(missing), "short_bodies:", len(short))
          if missing[:5]:
              print("first_missing_examples:", missing[:5])
          PY

      - name: Upload bundle artifact (sheet)
        uses: actions/upload-artifact@v4
        with:
          name: mna-bundle-sheet-${{ github.run_id }}
          # 送信用WF側で bundle/ をそのまま --bundle-dir に渡すため **ディレクトリ** を指す
          path: |
            bundle/meta.json
            bundle/summaries.json
            bundle/summaries_ayeyar.json
            bundle/digest.pdf
            bundle/attachment_name.txt
            bundle/bodies.json
          retention-days: 2
          if-no-files-found: error

  # === 手動実行（本番 / 開発のどちらも UI から選択） ===
  manual-run:
    if: github.event_name == 'workflow_dispatch'
    # main を選べば production / develop を選べば development
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (手動で選んだブランチ)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ▼ prod/dev で環境変数だけを切り替え（処理は変更しない）
      - name: Export env (prod/dev switch by branch)
        run: |
          if [ "${GITHUB_REF_NAME}" = "develop" ]; then
            {
              echo "GEMINI_API_KEY_MIZZIMA=${{ secrets.GEMINI_API_TEST_KEY_MIZZIMA }}";
              echo "GEMINI_API_KEY_BBC=${{ secrets.GEMINI_API_TEST_KEY_BBC }}";
              echo "GEMINI_API_KEY_IRRAWADDY=${{ secrets.GEMINI_API_TEST_KEY_IRRAWADDY }}";
              echo "GEMINI_API_KEY_KHITTHIT=${{ secrets.GEMINI_API_TEST_KEY_KHITTHIT }}";
              echo "GEMINI_API_KEY_MYANMARNOW=${{ secrets.GEMINI_API_TEST_KEY_MYANMARNOW }}";
              echo "GEMINI_API_KEY_DVB=${{ secrets.GEMINI_API_TEST_KEY_DVB }}";
              echo "GEMINI_API_SUMMARY_KEY=${{ secrets.GEMINI_API_TEST_SUMMARY_KEY }}";
              echo "GEMINI_API_DEDUPE_KEY=${{ secrets.GEMINI_API_TEST_DEDUPE_KEY }}";
              echo "GEMINI_API_FULLTEXT_KEY=${{ secrets.GEMINI_API_TEST_FULLTEXT_KEY }}";
              echo "MNA_SHEET_NAME=dev";
              echo "CSV_EMAIL_RECIPIENTS=${{ secrets.CSV_EMAIL_RECIPIENTS }}";
            } >> "$GITHUB_ENV"
          else
            {
              echo "GEMINI_API_KEY_MIZZIMA=${{ secrets.GEMINI_API_KEY_MIZZIMA }}";
              echo "GEMINI_API_KEY_BBC=${{ secrets.GEMINI_API_KEY_BBC }}";
              echo "GEMINI_API_KEY_IRRAWADDY=${{ secrets.GEMINI_API_KEY_IRRAWADDY }}";
              echo "GEMINI_API_KEY_KHITTHIT=${{ secrets.GEMINI_API_KEY_KHITTHIT }}";
              echo "GEMINI_API_KEY_MYANMARNOW=${{ secrets.GEMINI_API_KEY_MYANMARNOW }}";
              echo "GEMINI_API_KEY_DVB=${{ secrets.GEMINI_API_KEY_DVB }}";
              echo "GEMINI_API_SUMMARY_KEY=${{ secrets.GEMINI_API_SUMMARY_KEY }}";
              echo "GEMINI_API_DEDUPE_KEY=${{ secrets.GEMINI_API_DEDUPE_KEY }}";
              echo "GEMINI_API_FULLTEXT_KEY=${{ secrets.GEMINI_API_FULLTEXT_KEY }}";
              echo "MNA_SHEET_NAME=prod";
              echo "CSV_EMAIL_RECIPIENTS=${{ secrets.CSV_EMAIL_RECIPIENTS }}";
            } >> "$GITHUB_ENV"
          fi
          {
            echo "GEMINI_REQS_PER_MIN=6";
            echo "GEMINI_MIN_INTERVAL_SEC=2.5";
            echo "GEMINI_JITTER_SEC=0.5";
            echo "MNA_SHEET_ID=${{ secrets.MNA_SHEET_ID }}";
          } >> "$GITHUB_ENV"

          # ===== multi-line secret → ファイルに保存（$GITHUB_ENV には書かない）=====
          SA_FILE="$RUNNER_TEMP/sa.json"
          printf '%s' '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > "$SA_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$SA_FILE" >> "$GITHUB_ENV"
          echo "GOOGLE_SERVICE_ACCOUNT_FILE=$SA_FILE" >> "$GITHUB_ENV"

      - name: Assert vendored fonts & export PDF_FONT_PATH (only for build-bundle)
        if: ${{ inputs.mode == 'build-bundle' }}
        run: |
          set -euxo pipefail
          ls -al "$GITHUB_WORKSPACE/fonts" || true
          test -f "$GITHUB_WORKSPACE/fonts/NotoSansJP-Regular.ttf"
          test -f "$GITHUB_WORKSPACE/fonts/NotoSansJP-Bold.ttf"
          echo "PDF_FONT_PATH=$GITHUB_WORKSPACE/fonts/NotoSansJP-Regular.ttf" >> "$GITHUB_ENV"
          echo "PDF_FONT_BOLD_PATH=$GITHUB_WORKSPACE/fonts/NotoSansJP-Bold.ttf" >> "$GITHUB_ENV"
          echo "PDF_FONT_PATH=${PDF_FONT_PATH:-<not-set>}"

      - name: Run selected mode
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.mode != 'notify-email' }}
        run: |
          set -euo pipefail
          echo "Run case \"${{ inputs.mode }}\" in"
          case "${{ inputs.mode }}" in
            collect16)
              python sheet_pipeline.py collect-to-sheet --clear-yesterday
              ;;
            collect)
              python sheet_pipeline.py collect-to-sheet
              ;;
            build-bundle)
              python sheet_pipeline.py build-bundle --bundle-dir bundle
              ;;
            *)
              echo "unknown mode: ${{ inputs.mode }}" ; exit 1
              ;;
          esac

      # 手動実行でも通知を送れるように追加（collect/collect16 成功時のみ）
      - name: Notify by email via Python (manual run)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.mode == 'notify-email' && success() }}
        run: |
          set -euo pipefail
          BODY="$(printf '%s\n%s\n%s\n' \
            '✅ 22:50収集 完了（開発用）' \
            '・対象シート: 「dev」シートに追記済みです。' \
            '・翌 02:30 までにスプレッドシートの更新を完了してください。' )"
          python notify_done.py \
            --to "${CSV_EMAIL_RECIPIENTS}" \
            --subject "【MNA 記事収集】22:50収集 完了（開発用）" \
            --body "$BODY" \
            --sheet-url "https://docs.google.com/spreadsheets/d/${{ secrets.MNA_SHEET_ID }}/edit"
        env:
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}

      # === Diagnostics: ランナー環境と bundle の状況を確認（読み取りのみ） ===
      - name: Diagnostics | env + tree
        run: |
          set -euxo pipefail
          echo "PWD=$(pwd)"
          python --version
          find . -maxdepth 2 -type d -print | sort
          ls -al bundle || true

      - name: Diagnostics | Python helpers importable?
        run: |
          python - <<'PY'
          from importlib import import_module
          m = import_module("fetch_articles")
          req = ["translate_fulltexts_for_business", "build_combined_pdf_for_business", "_jp_date"]
          ok = all(hasattr(m, x) for x in req)
          print("helpers_importable:", ok)
          print("module_file:", getattr(m, "__file__", None))
          PY

      - name: Diagnostics | gemini keys present? (masked)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import os
          keys = sorted(k for k in os.environ if k.startswith("GEMINI"))
          print("gemini_key_names:", keys)
          # 値は True/False のみ表示（中身は GitHub が自動マスク）
          print("gemini_keys_nonempty:", {k: bool(os.environ.get(k)) for k in keys})
          PY

      # ←← 先に build-bundle を実行して bundle を生成
      - name: Build bundle (PDF & attachment name)
        if: ${{ inputs.mode == 'build-bundle' }}
        env:
          PYTHONPATH: .
          MNA_LOG_LEVEL: INFO
        run: |
          set -euxo pipefail
          python sheet_pipeline.py build-bundle --bundle-dir bundle
          echo "--- bundle after build-bundle ---"
          ls -al bundle

      - name: Diagnostics | summaries/bodies coverage
        run: |
          python - <<'PY'
          import os, json, sys
          b = "bundle"
          s = os.path.join(b, "summaries.json")
          if not os.path.exists(s):
              print("[!] bundle/summaries.json not found (skipping coverage)"); sys.exit(0)
          summaries = json.load(open(s, encoding="utf-8"))
          print("selected_count:", len(summaries))
          bp = os.path.join(b, "bodies.json")
          cache = {}
          if os.path.exists(bp):
              cache = json.load(open(bp, encoding="utf-8"))
          missing = []
          short = []
          for it in summaries:
            u = it.get("url","")
            if not u: continue
            body = (cache.get(u) or {}).get("body","")
            if not body:
              missing.append(u)
            elif len(body.strip()) < 80:
              short.append(u)
          print("in_cache:", len(cache), "missing_bodies:", len(missing), "short_bodies:", len(short))
          if missing[:5]:
            print("first_missing_examples:", missing[:5])
          PY

      - name: Upload bundle (only when built) (sheet)
        if: ${{ inputs.mode == 'build-bundle' }}
        uses: actions/upload-artifact@v4
        with:
          name: mna-bundle-sheet-${{ github.run_id }}
          path: |
            bundle/meta.json
            bundle/summaries.json
            bundle/summaries_ayeyar.json
            bundle/digest.pdf
            bundle/attachment_name.txt
            bundle/bodies.json
          retention-days: 2
          if-no-files-found: ignore
