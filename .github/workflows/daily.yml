name: Daily Myanmar News Digest

on:
  schedule:
    - cron: "30 16 * * *" # ミャンマー時間 23:00（UTC+6:30）
  workflow_dispatch: # 手動＝開発で実行

jobs:
  prod:
    if: (github.event_name == 'schedule' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    name: Run (production / main)
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: daily-digest-production
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install "fugashi[unidic-lite]" ipadic
          pip install --upgrade google-genai google-api-core
          rm -rf ~/.cache/huggingface

      - name: Run fetch script
        env:
          TZ: Asia/Yangon
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
          INTERNAL_EMAIL_RECIPIENTS: ${{ secrets.INTERNAL_EMAIL_RECIPIENTS }}
          GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_SUMMARY_KEY }}
          GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_DEDUPE_KEY }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
        run: python fetch_articles.py

  dev:
    if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/develop'
    name: Run (development / develop)
    runs-on: ubuntu-latest
    environment: development
    concurrency:
      group: daily-digest-development
      cancel-in-progress: true # 手動は新しい方を優先して前の実行を止める

    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install "fugashi[unidic-lite]" ipadic
          pip install --upgrade google-genai google-api-core
          rm -rf ~/.cache/huggingface

      - name: Run fetch script
        env:
          TZ: Asia/Yangon
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
          INTERNAL_EMAIL_RECIPIENTS: ${{ secrets.INTERNAL_EMAIL_RECIPIENTS }}
          GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_TEST_SUMMARY_KEY }}
          GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_TEST_DEDUPE_KEY }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
        run: python fetch_articles.py
