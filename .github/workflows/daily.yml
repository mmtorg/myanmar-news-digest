# .github/workflows/daily.yml
name: Daily Myanmar News Digest

on:
  schedule:
    - cron: "5 0 * * *" # UTC 00:05 = MMT 06:35 / JST 09:05 など。必要に応じて調整
  workflow_dispatch:

concurrency:
  group: daily-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  TZ: Asia/Yangon

jobs:
  dev:
    name: Dev run (with memory profiling)
    runs-on: ubuntu-latest

    # develop ブランチのみで動かしたい場合はコメント解除
    # if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies (if requirements.txt exists)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f requirements.txt ]]; then
            python -m pip install -U pip
            pip install -r requirements.txt
          else
            echo "requirements.txt not found; skipping pip install"
          fi

      - name: Run fetch script (DEV) (with memory profiling, capture even on failure)
        id: run_with_prof
        shell: bash
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER_TEST }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS_TEST }}
          INTERNAL_EMAIL_RECIPIENTS: ${{ secrets.INTERNAL_EMAIL_RECIPIENTS_TEST }}
          GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_SUMMARY_KEY_TEST }}
          GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_DEDUPE_KEY_TEST }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID_TEST }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET_TEST }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN_TEST }}
        run: |
          set -uo pipefail  # -e は外す（途中で落とさない）
          TIME_FILE="time.txt"

          # 実コマンドを計測して終了コードを保持（失敗しても継続）
          /usr/bin/time -v python fetch_articles.py 2> "$TIME_FILE"
          CMD_STATUS=$?

          # Max RSS を抽出（無ければ空のまま）
          MAX_RSS_KB=$(grep -E 'Maximum resident set size' "$TIME_FILE" | awk '{print $(NF-1)}' || true)
          echo "MAX_RSS_KB=$MAX_RSS_KB" >> "$GITHUB_ENV"
          echo "CMD_STATUS=$CMD_STATUS" >> "$GITHUB_ENV"

          echo "---- /usr/bin/time -v raw ----"
          cat "$TIME_FILE" || true

          # ここでは終了させない（後続Summaryで出力してから最終的に終了コードを返す）
          exit 0

      - name: Upload raw time.txt (DEV)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dev-time-txt
          path: time.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Memory summary (DEV)
        if: always()
        shell: bash
        run: |
          echo "### Memory report — GNU time on Ubuntu" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [[ -n "${MAX_RSS_KB:-}" ]]; then
            echo "- **Max RSS**: ${MAX_RSS_KB} KB" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Max RSS**: (not captured)" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "- **Command exit status**: ${CMD_STATUS:-unknown}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>raw /usr/bin/time -v</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f time.txt ]]; then
            # Markdown の表崩れ防止
            sed 's/|/\\|/g' time.txt >> "$GITHUB_STEP_SUMMARY"
          else
            echo "(time.txt not found)" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Fail job if the command failed (DEV)
        if: always()
        shell: bash
        run: |
          # 元のコマンドの終了コードを返してジョブの成否を正しく反映
          exit "${CMD_STATUS:-1}"

  prod:
    name: Prod run (with memory profiling)
    runs-on: ubuntu-latest
    needs: dev

    # main ブランチのみで動かしたい場合はコメント解除
    # if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies (if requirements.txt exists)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f requirements.txt ]]; then
            python -m pip install -U pip
            pip install -r requirements.txt
          else
            echo "requirements.txt not found; skipping pip install"
          fi

      - name: Run fetch script (PROD) (with memory profiling, capture even on failure)
        id: run_with_prof
        shell: bash
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
          INTERNAL_EMAIL_RECIPIENTS: ${{ secrets.INTERNAL_EMAIL_RECIPIENTS }}
          GEMINI_API_SUMMARY_KEY: ${{ secrets.GEMINI_API_SUMMARY_KEY }}
          GEMINI_API_DEDUPE_KEY: ${{ secrets.GEMINI_API_DEDUPE_KEY }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
        run: |
          set -uo pipefail  # -e は外す（途中で落とさない）
          TIME_FILE="time.txt"

          # 実コマンドを計測して終了コードを保持（失敗しても継続）
          /usr/bin/time -v python fetch_articles.py 2> "$TIME_FILE"
          CMD_STATUS=$?

          # Max RSS を抽出（無ければ空のまま）
          MAX_RSS_KB=$(grep -E 'Maximum resident set size' "$TIME_FILE" | awk '{print $(NF-1)}' || true)
          echo "MAX_RSS_KB=$MAX_RSS_KB" >> "$GITHUB_ENV"
          echo "CMD_STATUS=$CMD_STATUS" >> "$GITHUB_ENV"

          echo "---- /usr/bin/time -v raw ----"
          cat "$TIME_FILE" || true

          # ここでは終了させない（後続Summaryで出力してから最終的に終了コードを返す）
          exit 0

      - name: Upload raw time.txt (PROD)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-time-txt
          path: time.txt
          if-no-files-found: ignore
          retention-days: 30

      - name: Memory summary (PROD)
        if: always()
        shell: bash
        run: |
          echo "### Memory report — GNU time on Ubuntu" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [[ -n "${MAX_RSS_KB:-}" ]]; then
            echo "- **Max RSS**: ${MAX_RSS_KB} KB" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Max RSS**: (not captured)" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "- **Command exit status**: ${CMD_STATUS:-unknown}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>raw /usr/bin/time -v</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f time.txt ]]; then
            # Markdown の表崩れ防止
            sed 's/|/\\|/g' time.txt >> "$GITHUB_STEP_SUMMARY"
          else
            echo "(time.txt not found)" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Fail job if the command failed (PROD)
        if: always()
        shell: bash
        run: |
          # 元のコマンドの終了コードを返してジョブの成否を正しく反映
          exit "${CMD_STATUS:-1}"
